openapi: 3.0.3
info:
  title: ATU Lab Equipment Loaner API
  version: 1.0.0
  description: >
    REST API for managing users, equipment, and embedded booking history.
    Bookings are stored as embedded subdocuments within each equipment item.
servers:
  - url: http://localhost:3000/api/v1
    description: Local development

tags:
  - name: Users
  - name: Equipment
  - name: Bookings (Embedded)

paths:
  ############################
  # Users
  ############################
  /users:
    get:
      tags: [Users]
      summary: List users
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/User' }
    post:
      tags: [Users]
      summary: Create user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UserCreate' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { $ref: '#/components/responses/ValidationError' }

  /users/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: string, description: MongoDB ObjectId }
    get:
      tags: [Users]
      summary: Get user by id
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Not found }
    put:
      tags: [Users]
      summary: Replace user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UserCreate' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { $ref: '#/components/responses/ValidationOrIdError' }
        '404': { description: Not found }
    patch:
      tags: [Users]
      summary: Update user (partial)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UserUpdate' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { $ref: '#/components/responses/ValidationOrIdError' }
        '404': { description: Not found }
    delete:
      tags: [Users]
      summary: Delete user
      responses:
        '204': { description: Deleted }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Not found }

  ############################
  # Equipment
  ############################
  /equipment:
    get:
      tags: [Equipment]
      summary: List equipment (with optional filters)
      parameters:
        - in: query
          name: category
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string, enum: [available, reserved, out] }
        - in: query
          name: q
          schema: { type: string, description: Text search on name/serial }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Equipment' }
    post:
      tags: [Equipment]
      summary: Create equipment
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EquipmentCreate' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Equipment' }
        '400': { $ref: '#/components/responses/ValidationError' }

  /equipment/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: string, description: MongoDB ObjectId }
    get:
      tags: [Equipment]
      summary: Get equipment by id (includes embedded bookings)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Equipment' }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Not found }
    patch:
      tags: [Equipment]
      summary: Update equipment (partial)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EquipmentUpdate' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Equipment' }
        '400': { $ref: '#/components/responses/ValidationOrIdError' }
        '404': { description: Not found }
    delete:
      tags: [Equipment]
      summary: Delete equipment
      responses:
        '204': { description: Deleted }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Not found }

  ############################
  # Embedded Bookings under Equipment
  ############################
  /equipment/{id}/bookings:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: string, description: Equipment ObjectId }
    get:
      tags: [Bookings (Embedded)]
      summary: List embedded bookings for an equipment item
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/EmbeddedBooking' }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Equipment not found }
    post:
      tags: [Bookings (Embedded)]
      summary: Add a booking to an equipment item
      description: Adds a new embedded booking after checking for overlapping date ranges.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingCreateEmbedded' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EmbeddedBooking' }
        '400': { $ref: '#/components/responses/ValidationOrIdError' }
        '404': { description: Equipment not found }
        '409': { description: Overlapping booking exists }

  /equipment/{id}/bookings/{bookingId}/approve:
    patch:
      tags: [Bookings (Embedded)]
      summary: Approve a pending embedded booking
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: path
          name: bookingId
          required: true
          schema: { type: string }
      responses:
        '200': { description: Approved, content: { application/json: { schema: { $ref: '#/components/schemas/EmbeddedBooking' } } } }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Booking not found or not pending }

  /equipment/{id}/bookings/{bookingId}/deny:
    patch:
      tags: [Bookings (Embedded)]
      summary: Deny a pending embedded booking
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: path
          name: bookingId
          required: true
          schema: { type: string }
      responses:
        '200': { description: Denied, content: { application/json: { schema: { $ref: '#/components/schemas/EmbeddedBooking' } } } }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Booking not found or not pending }

  /equipment/{id}/bookings/{bookingId}/check-out:
    patch:
      tags: [Bookings (Embedded)]
      summary: Mark an approved booking as checked out
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: path
          name: bookingId
          required: true
          schema: { type: string }
      responses:
        '200': { description: Checked out, content: { application/json: { schema: { $ref: '#/components/schemas/EmbeddedBooking' } } } }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Booking not found or not approved }

  /equipment/{id}/bookings/{bookingId}/check-in:
    patch:
      tags: [Bookings (Embedded)]
      summary: Mark a checked-out booking as returned
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: path
          name: bookingId
          required: true
          schema: { type: string }
      responses:
        '200': { description: Returned, content: { application/json: { schema: { $ref: '#/components/schemas/EmbeddedBooking' } } } }
        '400': { $ref: '#/components/responses/IdError' }
        '404': { description: Booking not found or not checked_out }

components:
  ############################
  # Reusable responses
  ############################
  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            invalid:
              value:
                message: Validation error
                issues:
                  - path: [ "name" ]
                    message: Required
    IdError:
      description: Invalid ObjectId
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            invalid:
              value: { message: Invalid ID }
    ValidationOrIdError:
      description: Invalid ObjectId or body validation failed
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  ############################
  # Schemas
  ############################
  schemas:
    Error:
      type: object
      properties:
        message: { type: string }
        issues:
          type: array
          items:
            type: object
            properties:
              path:
                type: array
                items: { type: string }
              message: { type: string }

    # Users
    User:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        email: { type: string, format: email }
        phone: { type: string }
        dob: { type: string, format: date }
        role: { type: string, enum: [student, staff, admin] }
        dateJoined: { type: string, format: date-time }
        lastUpdated: { type: string, format: date-time }

    UserCreate:
      type: object
      required: [name, email, password]
      properties:
        name: { type: string, minLength: 2, maxLength: 50 }
        email: { type: string, format: email }
        password: { type: string, minLength: 8, maxLength: 128 }
        phone: { type: string }
        dob: { type: string, format: date }
        role: { type: string, enum: [student, staff, admin], description: "Defaults to student" }

    UserUpdate:
      type: object
      properties:
        name: { type: string, minLength: 2, maxLength: 50 }
        email: { type: string, format: email }
        phone: { type: string }
        dob: { type: string, format: date }
        role: { type: string, enum: [student, staff, admin] }
        password: { type: string, minLength: 8, maxLength: 128 }

    # Equipment & Embedded Bookings
    EmbeddedBooking:
      type: object
      properties:
        bookingId: { type: string, description: "UUID or generated string id" }
        userId: { type: string, description: "MongoDB ObjectId (string) referencing users._id" }
        startDate: { type: string, format: date }
        endDate: { type: string, format: date }
        status:
          type: string
          enum: [pending, approved, denied, checked_out, returned]
          default: pending
        notes: { type: string, maxLength: 500 }
      required: [ bookingId, userId, startDate, endDate, status ]

    BookingCreateEmbedded:
      type: object
      properties:
        userId: { type: string }
        startDate: { type: string, format: date }
        endDate: { type: string, format: date }
        notes: { type: string, maxLength: 500 }
      required: [ userId, startDate, endDate ]

    EquipmentCreate:
      type: object
      properties:
        name: { type: string, minLength: 2, maxLength: 100 }
        category: { type: string, minLength: 2, maxLength: 50 }
        serial: { type: string, minLength: 1, maxLength: 100 }
        condition: { type: string, enum: [New, Good, Fair, Poor] }
        status: { type: string, enum: [available, reserved, out], default: available }
        location: { type: string, minLength: 2, maxLength: 100 }
        bookings:
          type: array
          items: { $ref: '#/components/schemas/EmbeddedBooking' }
          default: []
      required: [ name, category, serial, condition, location ]

    EquipmentUpdate:
      type: object
      properties:
        name: { type: string }
        category: { type: string }
        serial: { type: string }
        condition: { type: string, enum: [New, Good, Fair, Poor] }
        status: { type: string, enum: [available, reserved, out] }
        location: { type: string }
        bookings:
          type: array
          items: { $ref: '#/components/schemas/EmbeddedBooking' }

    Equipment:
      allOf:
        - $ref: '#/components/schemas/EquipmentCreate'
        - type: object
          properties:
            _id: { type: string }
            createdAt: { type: string, format: date-time }
            updatedAt: { type: string, format: date-time }
